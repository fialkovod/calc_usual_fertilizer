{% extends 'project/base.html' %}
{% load render_table from django_tables2 %}
{% load getattr %}
{% load compress %}
{% block tg_head_tags %}
    <!--suppress GrazieInspection -->
    <meta property="og:title" content="Hydroponics NPK Calculator from Ready-Made Fertilizers"/>
    <meta property="og:description"
          content="Use this calculator to create custom nutrient profiles using various commercial fertilizers for hydroponics."/>
    <meta property="og:image" content="https://ponics.online/static/images/npk-calc.webp"/>
    <meta property="og:url" content="https://ponics.online/calc/common_fertilizers/"/>

{% endblock %}

{% block content %}

    <script src="/static/jquery.qrcode.min.js"></script>
    <script src="/static/popper.min.js"></script>
    <script src="/static/lz-string.min.js"></script>
    <script src="/static/select2.min.js"></script>
    <link href="/static/select2.min.css" rel="stylesheet"/>


    <style>
        #qrcode {
            text-align: center;
            margin-top: 50px;
            margin-bottom: 50px;
        }

        .modal-content {
            min-width: 350px;
        }


        #element-matrix > tbody > tr > td {
            width: 40px;
        }

        input[type="number"] {
            width: 100px;
        }
    </style>



    <div class="accordion mb-5" id="fertilizerInfo">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button collapsed alert alert-warning text-center fw-bold"
                        type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">

                    Почему не стоит использовать комплексные удобрения? Нажмите, чтобы узнать!

                </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne"
                 data-bs-parent="#fertilizerInfo">
                <div class="accordion-body">
                    <p>
                        ## Почему комплексные удобрения могут быть вредны для гидропоники<br>
                        ### 1. Непредсказуемость профиля питания<br>
                        Комплексные удобрения содержат несколько питательных элементов в одной формуле. Однако, их
                        соотношение и
                        доступность для растений могут сильно варьироваться. Это значит, что вы не можете точно знать,
                        сколько именно
                        каждого элемента получает ваше растение. В гидропонике, где растения растут в водной среде без
                        почвы, это
                        особенно критично. Если растения не получают нужные им элементы в нужных количествах, их рост
                        может замедлиться,
                        а урожайность снизиться.<br>

                        ### 2. Контроль за питательными веществами<br>

                        С простыми солями, такими как нитрат калия или сульфат магния, вы можете легко контролировать
                        концентрацию
                        питательных веществ в растворе. Это можно сделать с помощью измерения плотности раствора и его
                        электропроводности:<br>

                        - Плотность показывает, сколько солей растворено в воде.<br>
                        - Электропроводность указывает на общее количество ионов в растворе.<br>

                        Эти параметры можно легко измерить с помощью простых приборов. Таким образом, вы можете точно
                        регулировать
                        уровень питательных веществ и адаптировать его под потребности ваших растений.<br>

                        ### 3. Доверие к производителям комплексных удобрений<br>

                        Когда вы используете комплексные удобрения, вы полагаетесь на информацию от производителя о том,
                        какие элементы
                        и в каком количестве они содержат. Однако эта информация может быть не всегда точной или
                        актуальной. Профили
                        питания, которые делятся людьми, использующими комплексные удобрения, могут не соответствовать
                        реальности их
                        конкретной системы. Это может привести к неправильному пониманию потребностей растений и ошибкам
                        в уходе за
                        ними.<br>

                        ### 4. Риски для развития гидропоники<br>

                        Использование комплексных удобрений может создать ложное чувство уверенности у новичков в
                        гидропонике. Они могут
                        думать, что с комплексами все будет просто и удобно, но на практике это может привести к
                        проблемам:<br>

                        - Дефицит питательных веществ: Если в комплексе не хватает какого-то элемента, это может
                        негативно сказаться на
                        росте растений.<br>
                        - Избыток питательных веществ: Если элементы не усваиваются должным образом, это может привести
                        к токсичности и
                        повреждению корней.<br>


                    </p>
                    <p>
                        ### Заключение<br>

                        В итоге, использование простых солей вместо комплексных удобрений дает вам больше контроля над
                        процессом питания
                        растений. Вы можете точно регулировать состав раствора и адаптировать его под конкретные условия
                        вашей
                        гидропонной системы. Это особенно важно для успешного роста растений и получения хорошего
                        урожая. Поэтому стоит
                        задуматься о том, какие удобрения вы используете в своей практике гидропоники! <br>
                        <span class="text-danger">в этом  калькуляторе так же можно использовать простые соли</span><br>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row zoom-controls d-flex flex-row justify-content-start">

        <button id="zoom-in" class="btn btn-sm btn-secondary">+</button>
        <button id="zoom-out" class="btn btn-sm btn-secondary">−</button>
        <button id="reset-zoom" class="btn btn-sm btn-secondary">Reset</button>
    </div>




    <style>

        .zoom-controls button {
            margin: 2px; /* минимальные отступы */
            padding: 3px 6px; /* уменьшенный padding */
            font-size: 10px; /* уменьшенный шрифт на кнопках */
            width: 50px; /* уменьшенная ширина кнопок */
        }
    </style>


    <div class="row d-flex flex-wrap justify-content-start">
        <!-- Выбор всех -->
        <button id="select-all-button" class="btn btn-sm btn-primary m-1 w-auto">
            <i class="bi bi-check2-all"></i> Выбрать все
        </button>
        <!-- Убрать все -->
        <button id="de-select-all-button" class="btn btn-sm btn-secondary m-1 w-auto">
            <i class="bi bi-x-circle"></i> Убрать все
        </button>
        <!-- Калькулятор кислот -->
        <button type="button" class="btn btn-sm btn-danger m-1 w-auto" data-bs-toggle="modal"
                data-bs-target="#fert_kislota">
            <i class="bi bi-plus-circle"></i> Калькулятор кислот
        </button>
        <!-- Доступные только для авторизованных пользователей -->
        {% if request.user.is_authenticated %}
            <!-- Составить в OHPG -->
            <button type="button" class="btn btn-sm btn-warning m-1 w-auto" data-bs-toggle="modal"
                    data-bs-target="#add_plant_profile">
                <i class="bi bi-calculator"></i> Составить в OHPG
            </button>
            <!-- Посмотреть модерацию удобрений -->
            <button class="btn btn-sm btn-info m-1 w-auto" type="button" data-bs-toggle="collapse"
                    data-bs-target="#fertilizersList" aria-expanded="false" aria-controls="fertilizersList">
                <i class="bi bi-eye"></i> Посмотреть модерацию удобрений
            </button>
            <!-- Добавить свое удобрение -->
            <button type="button" class="btn btn-sm btn-success m-1 w-auto" data-bs-toggle="modal"
                    data-bs-target="#add_plant_fert">
                <i class="bi bi-plus-circle"></i> Добавить свое удобрение в каталог
            </button>
            <div class="row d-flex flex-wrap justify-content-start mt-1">
                <!-- Сохранить ссылку -->
                <button type="button" class="btn btn-sm btn-outline-primary m-1 w-auto" data-bs-toggle="modal"
                        data-bs-target="#add_link">
                    <i class="bi bi-plus-circle"></i> Сохранить ссылку
                </button>
                <!-- Ссылки -->
                <a class="btn btn-sm btn-outline-primary m-1 w-auto" href="{% url 'links' %}">
                    <i class="bi bi-link"></i> Ссылки
                </a>
            </div>
        {% else %}
            <!-- Для неавторизованных пользователей -->
            <button type="button" class="btn btn-danger btn-lg w-100 mt-2">
                <i class="bi bi-exclamation-circle"></i> Авторизуйтесь чтобы добавлять свои удобрения
            </button>
        {% endif %}
        <!-- Модерация -->
        <div class="d-inline-block mt-2">
            <span>Всего на модерацию: {{ for_moder }}</span>
        </div>
    </div>



    <div class="row mt-3">
        <div id="url-display">
            <h5> Ссылка на текущее состояние <span>
                   <button class="btn btn-sm btn-outline-primary w-auto d-inline-block" id="copy-button">
                    <i class="bi bi-clipboard"></i> Копировать
                </button>
            </span></h5>
            <p id="current-url" style="  size: auto;  overflow: scroll;"> {{ request.get_full_path }}    </p>

            {% include 'calc/modal.html' with id='add_link' h5="Добавить ссылку" btn_name='добавить' form=linkform action="links" %}
        </div>
    </div>
    <div class="row" id="result"></div>

    {% include 'calc/fert_modal.html' with id='add_plant_fert' h5="Добавить удобрение" btn_name="добавить" form=fert_form action="fert_new" %}
    {% include 'calc/fert_modal_kislota.html' with id='fert_kislota' h5="Расчет кислот" btn_name="" form=fert_form action="fert_new" %}
    {% include 'calc/fert_modal.html' with id='edit_plant_fert' h5="Редактировать удобрение" btn_name="редактировать" pk=1 form=fert_form action="fert_new_edit" %}
    <div class="row">
        <select id="fertilizer-select" class="form-select" style="width: 100%;">
            <option value="">Выберите удобрение</option>
            {% for fertilizer in fertilizers %}
                <option
                        id="opt-{{ fertilizer.id }}"
                        value="{{ fertilizer.id }}"
                        data-pk="{{ fertilizer.pk }}"
                        data-name="{{ fertilizer.name }}"
                        data-description="{{ fertilizer.description }}"
                        data-moderated="{{ fertilizer.moderated }}"
                        data-nh4="{{ fertilizer.N_NH4|default:0 }}"
                        data-no3="{{ fertilizer.N_NO3|default:0 }}"
                        data-nh2="{{ fertilizer.N_NH2|default:0 }}"
                        data-p="{{ fertilizer.P|default:0 }}"
                        data-k="{{ fertilizer.K|default:0 }}"
                        data-ca="{{ fertilizer.Ca|default:0 }}"
                        data-mg="{{ fertilizer.Mg|default:0 }}"
                        data-s="{{ fertilizer.S|default:0 }}"
                        data-cl="{{ fertilizer.Cl|default:0 }}"
                        data-fe="{{ fertilizer.Fe|default:0 }}"
                        data-zn="{{ fertilizer.Zn|default:0 }}"
                        data-cu="{{ fertilizer.Cu|default:0 }}"
                        data-mn="{{ fertilizer.Mn|default:0 }}"
                        data-mo="{{ fertilizer.Mo|default:0 }}"
                        data-b="{{ fertilizer.B|default:0 }}"
                        data-co="{{ fertilizer.Co|default:0 }}"
                        data-si="{{ fertilizer.Si|default:0 }}"
                        data-k2o="{{ fertilizer.get_k2o|default:0 }}"
                        data-p2o5="{{ fertilizer.get_p2o5|default:0 }}"
                        data-cao="{{ fertilizer.get_cao|default:0 }}"
                        data-mgo="{{ fertilizer.get_mgo|default:0 }}"
                        data-so3="{{ fertilizer.get_so3|default:0 }}"
                        data-n="{{ fertilizer.get_n|default:0 }}"
                        data-CaCl2_Ca="{{ fertilizer.CaCl2_Ca }}"
                        data-CaCl2_Cl="{{ fertilizer.CaCl2_Cl }}"
                        data-one-liter="-1"
                        data-description="{{ fertilizer.description|escapejs }}"
                        data-link="{{ fertilizer.link }}"
                        {% if request.user.is_staff %}
                        data-link2="/admin/calc/fertilizer/{{ fertilizer.pk }}/change/"
                        {% endif %}
                >{{ fertilizer.name }}
                    NH4:{{ fertilizer.N_NH4|default:0 }}
                    NO3:{{ fertilizer.N_NO3|default:0 }}
                    NH2:{{ fertilizer.N_NH2|default:0 }}
                    K2O:{{ fertilizer.get_k2o|default:0 }}
                    P2O5:{{ fertilizer.get_p2o5|default:0 }}
                    CaO:{{ fertilizer.get_cao|default:0 }}
                    MgO:{{ fertilizer.get_mgo|default:0 }}
                    SO3:{{ fertilizer.get_so3|default:0 }}
                    Cl:{{ fertilizer.Cl|default:0 }}
                    Fe:{{ fertilizer.Fe|default:0 }}
                    Zn:{{ fertilizer.Zn|default:0 }}
                    Cu:{{ fertilizer.Cu|default:0 }}
                    Mn:{{ fertilizer.Mn|default:0 }}
                    Mo:{{ fertilizer.Mo|default:0 }}
                    B:{{ fertilizer.B|default:0 }}
                    Co:{{ fertilizer.Co|default:0 }}
                    Si:{{ fertilizer.Si|default:0 }}

                </option>
            {% endfor %}
             {% include 'project/current_ferts.html' %}
        </select>
    </div>
    <div class="row table-responsive">
        <table class="table   fert">
            <thead>
            <tr>
                <th colspan="2" style="border: none;"></th>
                <th colspan="3" class="text-center" id="n_comon">N=</th>
            </tr>
            <tr>
                <th>Имя</th>
                <th>Граммы(мл для жидкого)</th>
                <th>NH4</th>
                <th>NO3</th>
                <th>NH2</th>
                <th>P</th>
                <th>K</th>
                <th>Ca</th>
                <th>Mg</th>
                <th>S</th>
                <th>Cl</th>
                <th>Fe</th>
                <th>Zn</th>
                <th>Cu</th>
                <th>Mn</th>
                <th>Mo</th>
                <th>B</th>
                <th>Co</th>
                <th>Si</th>
                <th>Удалить</th>
            </tr>
            </thead>
            <tbody>
            <tr id="sum-row">
                <td id="itog">Итого</td>
                <td id="sum-concentration" contenteditable="true">0.00</td>
                <td id="sum-nh4" contenteditable="true">0.00</td>
                <td id="sum-no3" contenteditable="true">0.00</td>
                <td id="sum-nh2" contenteditable="true">0.00</td>
                <td id="sum-p" contenteditable="true">0.00</td>
                <td id="sum-k" contenteditable="true">0.00</td>
                <td id="sum-ca" contenteditable="true">0.00</td>
                <td id="sum-mg" contenteditable="true">0.00</td>
                <td id="sum-s" contenteditable="true">0.00</td>
                <td id="sum-cl" contenteditable="true">0.00</td>
                <td id="sum-fe" contenteditable="true">0.00</td>
                <td id="sum-zn" contenteditable="true">0.00</td>
                <td id="sum-cu" contenteditable="true">0.00</td>
                <td id="sum-mn" contenteditable="true">0.00</td>
                <td id="sum-mo" contenteditable="true">0.00</td>
                <td id="sum-b" contenteditable="true">0.00</td>
                <td id="sum-co" contenteditable="true">0.00</td>
                <td id="sum-si" contenteditable="true">0.00</td>
            </tr>
            <tr id="comp-row">
                <td>Сравнение</td>
                <td id="comp-concentration">0.00</td>
                <td id="comp-nh4">0.00</td>
                <td id="comp-no3">0.00</td>
                <td id="comp-nh2">0.00</td>
                <td id="comp-p">0.00</td>
                <td id="comp-k">0.00</td>
                <td id="comp-ca">0.00</td>
                <td id="comp-mg">0.00</td>
                <td id="comp-s">0.00</td>
                <td id="comp-cl">0.00</td>
                <td id="comp-fe">0.00</td>
                <td id="comp-zn">0.00</td>
                <td id="comp-cu">0.00</td>
                <td id="comp-mn">0.00</td>
                <td id="comp-mo">0.00</td>
                <td id="comp-b">0.00</td>
                <td id="comp-co">0.00</td>
                <td id="comp-si">0.00</td>
            </tr>
            </tbody>
        </table>
    </div>
    <div class="row mt-3 col-12">
        <p>
            Расчетный ЕС: <span id="current-ec"></span> <br>
            <span class="text-warning">профиль рассчитывается в мг/л(ppm)!</span><br>
            <span id="id_profile_string">профиль для O-HPG</span><br>

            Количество литров: <input class="d-inline" type="number" min="0.1" step="0.1" id="litres" value="1"><br>

            nhh:no3 соотношение <span id="n-ratio"></span> или <span id="n-ratio-k"></span><br>
        </p>
    </div>
    <div class="row">
        <table id="element-matrix">
            <thead>
            <tr>
                <th></th>
                <th>N</th>
                <th>P</th>
                <th>K</th>
                <th>Ca</th>
                <th>Mg</th>
                <th>S</th>
            </tr>
            </thead>
            <tbody>
            <tr id="m-N">
                <td>N</td>
                <td contenteditable="false" id="m-N-N">0.00</td>
                <td contenteditable="false" id="m-N-P">0.00</td>
                <td contenteditable="false" id="m-N-K">0.00</td>
                <td contenteditable="false" id="m-N-Ca">0.00</td>
                <td contenteditable="false" id="m-N-Mg">0.00</td>
                <td contenteditable="false" id="m-N-S">0.00</td>
            </tr>
            <tr id="m-P">
                <td>P</td>
                <td contenteditable="false" id="m-P-N">0.00</td>
                <td contenteditable="false" id="m-P-P">0.00</td>
                <td contenteditable="false" id="m-P-K">0.00</td>
                <td contenteditable="false" id="m-P-Ca">0.00</td>
                <td contenteditable="false" id="m-P-Mg">0.00</td>
                <td contenteditable="false" id="m-P-S">0.00</td>
            </tr>
            <tr id="m-K">
                <td>K</td>
                <td contenteditable="false" id="m-K-N">0.00</td>
                <td contenteditable="false" id="m-K-P">0.00</td>
                <td contenteditable="false" id="m-K-K">0.00</td>
                <td contenteditable="false" id="m-K-Ca">0.00</td>
                <td contenteditable="false" id="m-K-Mg">0.00</td>
                <td contenteditable="false" id="m-K-S">0.00</td>
            </tr>
            <tr id="m-Ca">
                <td>Ca</td>
                <td contenteditable="false" id="m-Ca-N">0.00</td>
                <td contenteditable="false" id="m-Ca-P">0.00</td>
                <td contenteditable="false" id="m-Ca-K">0.00</td>
                <td contenteditable="false" id="m-Ca-Ca">0.00</td>
                <td contenteditable="false" id="m-Ca-Mg">0.00</td>
                <td contenteditable="false" id="m-Ca-S">0.00</td>
            </tr>
            <tr id="m-Mg">
                <td>Mg</td>
                <td contenteditable="false" id="m-Mg-N">0.00</td>
                <td contenteditable="false" id="m-Mg-P">0.00</td>
                <td contenteditable="false" id="m-Mg-K">0.00</td>
                <td contenteditable="false" id="m-Mg-Ca">0.00</td>
                <td contenteditable="false" id="m-Mg-Mg">0.00</td>
                <td contenteditable="false" id="m-Mg-S">0.00</td>
            </tr>
            <tr id="m-S">
                <td>S</td>
                <td contenteditable="false" id="m-S-N">0.00</td>
                <td contenteditable="false" id="m-S-P">0.00</td>
                <td contenteditable="false" id="m-S-K">0.00</td>
                <td contenteditable="false" id="m-S-Ca">0.00</td>
                <td contenteditable="false" id="m-S-Mg">0.00</td>
                <td contenteditable="false" id="m-S-S">0.00</td>
            </tr>
            </tbody>
        </table>
    </div>
    <div class="row">
        <div class="col-2">
            <p>Сравнение - введите профиль</p>
        </div>
        <div class="col-auto">
            <input type="text" id="input-string" class="w-auto"
                   placeholder="N=100 NO3=90 NH4=9 P=42 K=150 Ca=140 Mg=33 S=103 Cl=0 Fe=2.0 Mn=0.55 B=0.35 Zn=0.33 Cu=0.5 Mo=0.05 Co=0.0 Si=0"
            >
        </div>
    </div>
    <div class="row">
        <button class="btn btn-primary mb-3" onclick="toggleTable()">Скрыть/Показать таблицу блокировки элементов
        </button>
        <div id="table-container">
            <table class="table table-bordered">
                <thead>
                <tr>
                    <th>Элемент</th>
                    <th>Помогает усвоению</th>
                    <th>Блокирует усвоение</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>N_NH4</td>
                    <td>P</td>
                    <td>Ca, Mg</td>
                </tr>
                <tr>
                    <td>N_NO3</td>
                    <td>Ca, Mg</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>N_NH2</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>P</td>
                    <td>K</td>
                    <td>Zn, Fe</td>
                </tr>
                <tr>
                    <td>K</td>
                    <td>-</td>
                    <td>Ca, Mg</td>
                </tr>
                <tr>
                    <td>Ca</td>
                    <td>N_NO3</td>
                    <td>K, Mg</td>
                </tr>
                <tr>
                    <td>Mg</td>
                    <td>-</td>
                    <td>K</td>
                </tr>
                <tr>
                    <td>S</td>
                    <td>-</td>
                    <td>Mo</td>
                </tr>
                <tr>
                    <td>Cl</td>
                    <td>-</td>
                    <td>N_NO3</td>
                </tr>
                <tr>
                    <td>Fe</td>
                    <td>Mn</td>
                    <td>Zn, Cu</td>
                </tr>
                <tr>
                    <td>Zn</td>
                    <td>-</td>
                    <td>Fe</td>
                </tr>
                <tr>
                    <td>Cu</td>
                    <td>Fe</td>
                    <td>Mn</td>
                </tr>
                <tr>
                    <td>Mn</td>
                    <td>Fe</td>
                    <td>Cu</td>
                </tr>
                <tr>
                    <td>Mo</td>
                    <td>-</td>
                    <td>S</td>
                </tr>
                <tr>
                    <td>B</td>
                    <td>Ca</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>Co</td>
                    <td>N_NO3</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>Si</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
                </tbody>
            </table>

        </div>
    </div>

    {% if request.user.is_authenticated %}
        {% include 'calc/modal.html' with id='add_plant_profile' h5="Добавить удобрение" btn_name=btn_name form=form action="plant_profile_new" %}
        <div class="row collapse" id="fertilizersList">
            {% if  user.is_staff %}
                <a href="?moder=1">Показать только для модерации</a> <br>
                <a href="?all=1">Показать все</a> <br>
                <a href="{% url "fert_new_regen" %}">regen</a> <br>

            {% endif %}
            {% for i in user_fertilizers %}
                <div class="card card-body">
                    <div class="row">
                        <div class="col">
                            {{ i.name }} - добавлен в общий список: {{ i.moderated }}
                        </div>
                        {% if  user.is_staff %}
                            <div class="col">
                                {{ i.pk }}--{{ i.user }}--{{ i.show }}
                            </div>
                            <div class="col">
                                <a class="btn btn-sm btn-success"
                                   href="{% url "appr_common_fertilizer" i.pk %}">aproove</a><br>
                                <a href="https://ponics.online/admin/calc/fertilizer/{{ i.pk }}/change/">edit</a><br>
                                <a href="{% url "show_common_fertilizer" i.pk %}">скрыть/показать</a> <br>
                                link <a href="{{ i.link }}">{{ i.link }}</a><br>
                                {{ i.description }}<br>
                            </div>



                        {% endif %}
                        <div class="col">
                            {% if not i.moderated %}
                                <a class="btn btn-sm btn-danger"
                                   href="{% url "del_common_fertilizer" i.pk %}">удалить</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="row">
        <p>Реализованы проверки МАКРО соотношений и граммовок по Чеснокову <br>
            <span style="color:green">Зеленый</span> хорошо <br>
            <span style="color:darkgoldenrod">Желтый</span> мало <br>
            <span style="color:red">Красный</span> много <br>
            <span style="background-color:rgba(206, 19, 113, 0.66)">меньше/больше допустимого</span><br>

            Смотрим матрицу соотношений
        </p>

        <p>Добавлена возможность добавления собственных удобрений - они будут проходить процесс модерации. После
            модерации их нельзя будет редактировать.</p>

        <div id="qrcode"></div>
    </div>
    {% compress js %}

        <script>
            let currentZoom = parseFloat(localStorage.getItem('zoomLevel')) || 1;

            function applyViewportZoom(zoom) {
                const viewport = document.querySelector('meta[name="viewport"]');
                viewport.setAttribute('content', `width=device-width, initial-scale=${zoom}`);
            }

            function saveZoom() {
                localStorage.setItem('zoomLevel', currentZoom);
            }

            document.getElementById('zoom-in').addEventListener('click', function () {
                currentZoom = Math.min(3, currentZoom + 0.1); // Maximum zoom limit
                applyViewportZoom(currentZoom);
                saveZoom();
            });

            document.getElementById('zoom-out').addEventListener('click', function () {
                currentZoom = Math.max(0.1, currentZoom - 0.1); // Minimum zoom limit
                applyViewportZoom(currentZoom);
                saveZoom();
            });

            document.getElementById('reset-zoom').addEventListener('click', function () {
                currentZoom = 1;
                applyViewportZoom(currentZoom);
                saveZoom();
            });

            // Apply saved zoom on page load
            applyViewportZoom(currentZoom);
        </script>

        <script>
            function toggleTable() {
                const tableContainer = document.getElementById('table-container');
                if (tableContainer.style.display === 'none') {
                    tableContainer.style.display = 'block';
                } else {
                    tableContainer.style.display = 'none';
                }
            }

            $(document).ready(function () {
                $('#fertilizer-select').select2({
                    width: 'resolve',
                    placeholder: 'Выберите удобрение'
                });


            });

            let proverka_by = "all";
            let have_moder_fert = false;
            let colors = "";
            let newURL;
            let fieldNames = {
                "name": "name",
                "pk": "pk",
                "search": "search",
                "description": "description",
                "link": "link",
                "nh4": "N_NH4",
                "no3": "N_NO3",
                "nh2": "N_NH2",
                "p": "P",
                "k": "K",
                "ca": "Ca",
                "mg": "Mg",
                "s": "S",
                "cl": "Cl",
                "fe": "Fe",
                "zn": "Zn",
                "cu": "Cu",
                "mn": "Mn",
                "mo": "Mo",
                "b": "B",
                "co": "Co",
                "si": "Si",
                "k2o": "K2O",
                "p2o5": "P2O5",
                "cao": "CaO",
                "mgo": "MgO",
                "so3": "SO3",
                "cacl": "CaCl",
            };

            let elements_m = ['N', 'P', 'K', 'Ca', 'Mg', 'S', 'Cl', 'Fe', 'Zn', 'Cu', 'Mn', 'Mo', 'B', 'Co', 'Si'];
            let minValues = [56, 12, 59, 12, 12, 29, 0, 1, 0.05, 0.01, 0.1, 0.01, 0.1, 0, 0.0];
            let recommendedValues = [136, 53, 253, 144, 43, 138, 10, 2, 0.35, 0.1, 0.5, 0.05, 0.45, 0.05, 0.05];
            let maxValues = [217, 217, 592, 360, 84, 331, 20, 6, 0.5, 0.3, 1, 0.2, 0.95, 0.1, 0.1];

            let minRatios = [1, 0.2, 1.1, 0.2, 0.2, 0.5];
            let recommendedRatios = [1, 0.3, 1.8, 1, 0.3, 1];
            let maxRatios = [1, 1, 2.7, 1.6, 0.3, 1.5];

            function capitalizeFirstLetter(string) {
                return string.charAt(0).toUpperCase() + string.slice(1);
            }

            function calculateTextColor(value, element, recommended_v, min_v, max_v, pr_type) {
                let startColor = [210, 180, 0];
                let middleColor = [0, 128, 0];
                let endColor = [128, 0, 0];

                let elementIndex = elements_m.indexOf(element);
                let middleValue = recommended_v[elementIndex];

                let position;

                if (value <= middleValue) {
                    position = (value - min_v[elementIndex]) / (middleValue - min_v[elementIndex]);
                } else {
                    position = (value - middleValue) / (max_v[elementIndex] - middleValue);
                }

                let intermediateColor = [];
                for (let i = 0; i < 3; i++) {
                    if (value <= middleValue) {
                        intermediateColor[i] = Math.round(startColor[i] + (middleColor[i] - startColor[i]) * position);
                    } else {
                        intermediateColor[i] = Math.round(middleColor[i] + (endColor[i] - middleColor[i]) * position);
                    }
                }
                if (element in ['Cl', 'Fe', 'Zn', 'Cu', 'Mn', 'Mo', 'B', 'Co', 'Si']) {
                    pr_type = "gramm";
                }
                if (pr_type == "gramm") {
                    if (value <= min_v[elementIndex] || value >= max_v[elementIndex]
                    ) {
                        return {
                            color: `rgb(${intermediateColor[0]}, ${intermediateColor[1]}, ${intermediateColor[2]})`,
                            backgroundColor: `rgba(206, 19, 113, 0.66)`,

                        };
                    }
                }

                return {
                    color: `rgb(${intermediateColor[0]}, ${intermediateColor[1]}, ${intermediateColor[2]})`,
                    backgroundColor: 'rgba(56,218,47,0.2)',
                };
            }

            function updateMatrixFromSumRow(sumN, sumP, sumK, sumCa, sumMg, sumS, sumFe, sumZn, sumCu, sumMn, sumMo, sumB) {
                let first_row = [
                    {'e': $("#m-N-N"), 'f': sumN, 'l': sumN, 'name': "N"},
                    {'e': $("#m-N-P"), 'f': sumP, 'l': sumN, 'name': "P"},
                    {'e': $("#m-N-K"), 'f': sumK, 'l': sumN, 'name': "K"},
                    {'e': $("#m-N-Ca"), 'f': sumCa, 'l': sumN, 'name': "Ca"},
                    {'e': $("#m-N-Mg"), 'f': sumMg, 'l': sumN, 'name': "Mg"},
                    {'e': $("#m-N-S"), 'f': sumS, 'l': sumN, 'name': "S"},
                ];

                proverka_by = 'all';

                for (let i = 0; i < first_row.length; i++) {
                    first_row[i].e.text((first_row[i].f / first_row[i].l || 0).toFixed(2));
                    if (proverka_by == 'ratio' || proverka_by === 'all') {
                        colors = calculateTextColor(
                            first_row[i].f / first_row[i].l || 0, first_row[i].name,
                            recommendedRatios, minRatios, maxRatios, "ratio");
                    } else {
                        colors = {color: `rgb(0, 0, 0)`, backgroundColor: `rgb(250, 250, 250)`}
                    }

                    first_row[i].e.css('color', colors.color, 'background-color', colors.backgroundColor);
                }

                $("#m-N-K").css('background-color', 'rgba(56,218,47,0.2)');
                $("#m-Ca-K").css('background-color', 'rgba(56,218,47,0.2)');
                $("#m-Mg-K").css('background-color', 'rgba(56,218,47,0.2)');
                $("#m-P-N").text((sumN / sumP || 0).toFixed(2));
                $("#m-P-P").text((sumP / sumP || 0).toFixed(2));
                $("#m-P-K").text((sumK / sumP || 0).toFixed(2));
                $("#m-P-Ca").text((sumCa / sumP || 0).toFixed(2));
                $("#m-P-Mg").text((sumMg / sumP || 0).toFixed(2));
                $("#m-P-S").text((sumS / sumP || 0).toFixed(2));

                $("#m-K-N").text((sumN / sumK || 0).toFixed(2));
                $("#m-K-P").text((sumP / sumK || 0).toFixed(2));
                $("#m-K-K").text((sumK / sumK || 0).toFixed(2));
                $("#m-K-Ca").text((sumCa / sumK || 0).toFixed(2));
                $("#m-K-Mg").text((sumMg / sumK || 0).toFixed(2));
                $("#m-K-S").text((sumS / sumK || 0).toFixed(2));

                $("#m-Ca-N").text((sumN / sumCa || 0).toFixed(2));
                $("#m-Ca-P").text((sumP / sumCa || 0).toFixed(2));
                $("#m-Ca-K").text((sumK / sumCa || 0).toFixed(2));
                $("#m-Ca-Ca").text((sumCa / sumCa || 0).toFixed(2));
                $("#m-Ca-Mg").text((sumMg / sumCa || 0).toFixed(2));

                $("#m-Mg-N").text((sumN / sumMg || 0).toFixed(2));
                $("#m-Mg-P").text((sumP / sumMg || 0).toFixed(2));
                $("#m-Mg-K").text((sumK / sumMg || 0).toFixed(2));
                $("#m-Mg-Ca").text((sumCa / sumMg || 0).toFixed(2));
                $("#m-Mg-Mg").text((sumMg / sumMg || 0).toFixed(2));
                $("#m-Mg-S").text((sumS / sumMg || 0).toFixed(2));

                $("#m-S-N").text((sumN / sumS || 0).toFixed(2));
                $("#m-S-P").text((sumP / sumS || 0).toFixed(2));
                $("#m-S-K").text((sumK / sumS || 0).toFixed(2));
                $("#m-S-Ca").text((sumCa / sumS || 0).toFixed(2));
                $("#m-S-Mg").text((sumMg / sumS || 0).toFixed(2));
                $("#m-S-S").text((sumS / sumS || 0).toFixed(2));

                console.log("Матрица обновлена");


            }

            function updateProfileString() {
                const elements = [
                    {id: 'sum-no3', name: 'NO3'},
                    {id: 'sum-nh4', name: 'NH4'},
                    {id: 'sum-nh2', name: 'NH2'},
                    {id: 'sum-p', name: 'P'},
                    {id: 'sum-k', name: 'K'},
                    {id: 'sum-ca', name: 'Ca'},
                    {id: 'sum-mg', name: 'Mg'},
                    {id: 'sum-s', name: 'S'},
                    {id: 'sum-cl', name: 'Cl'},
                    {id: 'sum-fe', name: 'Fe'},
                    {id: 'sum-mn', name: 'Mn'},
                    {id: 'sum-b', name: 'B'},
                    {id: 'sum-zn', name: 'Zn'},
                    {id: 'sum-cu', name: 'Cu'},
                    {id: 'sum-mo', name: 'Mo'},
                    {id: 'sum-co', name: 'Co'},
                    {id: 'sum-si', name: 'Si'}
                ];

// Функция для безопасного получения и округления значения элемента
                const getElementValue = (id) => {
                    const element = document.querySelector(`#${id}`);
                    let value = element ? parseFloat(element.textContent) : 0;
                    value = isNaN(value) ? 0 : value;
                    return Math.round(value * 100) / 100; // Округление до 2 знаков
                };

// Рассчитать общий азот (N)
                const totalN = Math.round(
                    (getElementValue('sum-no3') +
                        getElementValue('sum-nh4') +
                        getElementValue('sum-nh2')) * 100
                ) / 100;

// Построить строку профиля
                let profileString = `N=${totalN}`;
                elements.forEach(({id, name}) => {
                    const value = getElementValue(id);
                    profileString += ` ${name}=${value}`;
                });

                console.log(profileString);

                $("#id_profile_string").text(profileString);

            }

            function copyURLToClipboard() {
                let copyText = document.getElementById("current-url");
                let textArea = document.createElement("textarea");
                textArea.value = copyText.innerText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand("copy");
                document.body.removeChild(textArea);
            }

            function updateURL() {
                let urlParams = new URLSearchParams();

                let paramsObject = {
                    data: []
                };

                $('.fert > tbody > tr:not(#sum-row)').each(function (index) {
                    let row = $(this);
                    let fertilizerId = row.find('.fertilizer-name').data('pk');
                    let grams = row.find('.grams-input').val();
                    let litres = $("#litres").val();
                    paramsObject.data.push({
                        f: fertilizerId,
                        g: grams,
                        l: litres,
                    });
                });
                updateProfileString();
                let encodedParams = LZString.compressToBase64(JSON.stringify(paramsObject));
                urlParams.set('params', encodedParams);

                if (have_moder_fert) {
                    console.log('have_moder_fert', have_moder_fert);
                } else {
                    newURL = window.location.pathname + '?' + urlParams.toString();
                    history.replaceState(null, '', newURL);
                }
                $('#qrcode').empty(); // Clear previous QR code
                $('#qrcode').qrcode({
                    text: "https://ponics.online" + newURL,
                    width: 200,
                    height: 200
                });
                updateDisplayedURL();
                console.log('have_moder_fert', have_moder_fert);
                if (have_moder_fert) {
                    $('#current-url').text('на модерации есть удобрения - ожидайте');
                    $("#copy-button").addClass("d-none");
                } else {
                    $("#copy-button").removeClass("d-none");
                }
            }

            function loadTableFromURL() {
                let urlParams = new URLSearchParams(window.location.search);

                $('.fert > tbody > tr:not(#sum-row):not(#comp-row)').remove();

                if (urlParams.has('params')) {
                    let encodedParams = urlParams.get('params');
                    let decodedParams = JSON.parse(LZString.decompressFromBase64(encodedParams));

                    if (decodedParams.data.length > 0) {
                        decodedParams.data.forEach(function (params, index) {
                            let selectedFertilizer = $('#fertilizer-select option[value="' + params.f + '"]');
                            if (selectedFertilizer.length) {
                                $("#litres").val(params.l);
                                addFertilizerRow(selectedFertilizer.data(), params.g);
                            }
                        });
                    }
                    recalculateSums();
                    updateURL();
                }
            }

            function updateDisplayedURL() {
                let currentURL = window.location.href;
                $('#current-url').text(currentURL);
                $("#id_original_url").val(currentURL);

            }

            class MM {
                constructor() {
                    this.N = 14.0067;
                    this.P = 30.973762;
                    this.K = 39.0983;
                    this.Ca = 40.078;
                    this.Mg = 24.305;
                    this.S = 32.065;
                    this.Cl = 35.453;
                    this.O = 15.999;
                    this.H = 1.00784;
                }
            }

            function calcEC(nh4, ca, mg, k) {
                const m = new MM();
                const a = nh4 * m.Ca * m.Mg * m.K;
                const b = ca * m.N * m.Mg * m.K;
                const c = mg * m.N * m.Ca * m.K;
                const d = k * m.N * m.Ca * m.Mg;
                const e = m.N * m.Ca * m.Mg * m.K;
                const f = m.N * m.Ca * m.Mg * m.K;

                if (f === 0 || (nh4 === 0 && ca === 0 && mg === 0 && k === 0)) {
                    return 0;
                }

                const ec = 0.095 * (a + 2 * b + 2 * c + d + 2 * e) / f;
                return ec;
            }


            function recalculateSums() {
                let ec = 0;
                have_moder_fert = false;
                let litres = parseFloat($("#litres").val().replace(',', '.'));

                let sumConcentration = 0;
                let sumNh4 = 0;
                let sumNo3 = 0;
                let sumNh2 = 0;
                let sumP = 0;
                let sumK = 0;
                let sumCa = 0;
                let sumMg = 0;
                let sumS = 0;
                let sumCl = 0;
                let sumFe = 0;
                let sumZn = 0;
                let sumCu = 0;
                let sumMn = 0;
                let sumMo = 0;
                let sumB = 0;
                let sumCo = 0;
                let sumSi = 0;

                $('.fert > tbody > tr:not(#sum-row):not(#comp-row)').each(function () {
                    let row = $(this);
                    let t_grams_data = row.find('input.grams-input').val() || "0";
                    let grams = parseFloat(t_grams_data.replace(',', '.')) || 0;

                    $('#fertilizer-select > option').each(function () {
                        const isModerated = $(this).data('moderated') === "True";
                        if (!have_moder_fert && !isModerated) {
                            have_moder_fert = isModerated;
                        }
                    });

                    sumConcentration += grams


                    row.find('.element').each(function () {
                        let element = $(this);
                        console.log("element", element);
                        console.log("element.data('elem')", element.data('elem'));
                        let elementValue = parseFloat(element.data('elem').toString().replace(',', '.')) || 0;
                        let multiplier = (grams / litres) * elementValue > 0 ? ((grams / litres) * elementValue * 10).toFixed(2) : "-";
                        element.text(multiplier);
                    });

                    let cur_ec = calcEC(
                        parseFloat(row.find('.element.nh4').text().replace(',', '.')) || 0,
                        parseFloat(row.find('.element.ca').text().replace(',', '.')) || 0,
                        parseFloat(row.find('.element.mg').text().replace(',', '.')) || 0,
                        parseFloat(row.find('.element.k').text().replace(',', '.')) || 0
                    );
                    ec += cur_ec;
                    //  console.log(row);
                    //  row.find('.ec').text(cur_ec.toFixed(2).toString() + ":" + ec.toFixed(2).toString());
                    sumNh4 += parseFloat(row.find('.element.nh4').text().replace(',', '.')) || 0;
                    sumNo3 += parseFloat(row.find('.element.no3').text().replace(',', '.')) || 0;
                    sumNh2 += parseFloat(row.find('.element.nh2').text().replace(',', '.')) || 0;
                    sumP += parseFloat(row.find('.element.p').text().replace(',', '.')) || 0;
                    sumK += parseFloat(row.find('.element.k').text().replace(',', '.')) || 0;
                    sumCa += parseFloat(row.find('.element.ca').text().replace(',', '.')) || 0;
                    sumMg += parseFloat(row.find('.element.mg').text().replace(',', '.')) || 0;
                    sumS += parseFloat(row.find('.element.s').text().replace(',', '.')) || 0;
                    sumCl += parseFloat(row.find('.element.cl').text().replace(',', '.')) || 0;
                    sumFe += parseFloat(row.find('.element.fe').text().replace(',', '.')) || 0;
                    sumZn += parseFloat(row.find('.element.zn').text().replace(',', '.')) || 0;
                    sumCu += parseFloat(row.find('.element.cu').text().replace(',', '.')) || 0;
                    sumMn += parseFloat(row.find('.element.mn').text().replace(',', '.')) || 0;
                    sumMo += parseFloat(row.find('.element.mo').text().replace(',', '.')) || 0;
                    sumB += parseFloat(row.find('.element.b').text().replace(',', '.')) || 0;
                    sumCo += parseFloat(row.find('.element.co').text().replace(',', '.')) || 0;
                    sumSi += parseFloat(row.find('.element.si').text().replace(',', '.')) || 0;
                });


                $('#current-ec').text(calcEC(sumNh4, sumCa, sumMg, sumK).toFixed(2));

                let sumN = sumNh4 + sumNo3 + sumNh2;
                proverka_by = 'all';
                updateMatrixFromSumRow(sumN, sumP, sumK, sumCa, sumMg, sumS);

                $('#n-ratio').text((sumNh4 / sumNo3).toFixed(2));
                $('#n-ratio-k').text("1  к " + (1 / (sumNh4 / sumNo3)).toFixed(0));

                $('#sum-concentration').text(sumConcentration.toFixed(2));
                $('#sum-nh4').text(sumNh4.toFixed(2) > 0 ? sumNh4.toFixed(2) : "-");
                $('#sum-no3').text(sumNo3.toFixed(2) > 0 ? sumNo3.toFixed(2) : "-");
                $('#sum-nh2').text(sumNh2.toFixed(2 > 0 ? sumNh2.toFixed(2) : "-"));

                let elements = ['N', 'P', 'K', 'Ca', 'Mg', 'S', 'Cl', 'Fe', 'Zn', 'Cu', 'Mn', 'Mo', 'B', 'Co', 'Si'];
                let sums = [sumNh4 + sumNo3 + sumNh2, sumP, sumK, sumCa, sumMg, sumS, sumCl, sumFe, sumZn, sumCu, sumMn, sumMo, sumB, sumCo, sumSi];

                for (let i = 0; i < elements.length; i++) {
                    let element = elements[i];
                    let sum = sums[i];
                    if (element == 'N') {
                        if (proverka_by === 'gramm' || proverka_by === 'all') {
                            colors = calculateTextColor(sum, element, recommendedValues, minValues, maxValues, "gramm");
                        } else {
                            colors = {color: `rgb(0, 0, 0)`, 'backgroundColor': `rgb(250, 250, 250)`};
                        }
                        $('#sum-nh4').css('color', colors.color,);
                        $('#sum-nh4').css('background-color', colors.backgroundColor);

                        $('#sum-no3').css('color', colors.color,);
                        $('#sum-no3').css('background-color', colors.backgroundColor);

                        $('#sum-nh2').css('color', colors.color,);
                        $('#sum-nh2').css('background-color', colors.backgroundColor);

                    } else {
                        if (sum == 0) {
                            $('#' + 'sum-' + element.toLowerCase()).text("-");
                        } else {
                            $('#' + 'sum-' + element.toLowerCase()).text(sum.toFixed(2));
                        }
                        if (proverka_by == 'gramm' || proverka_by === 'all') {
                            colors = calculateTextColor(sum, element, recommendedValues, minValues, maxValues, "gramm");
                        } else {
                            colors = {
                                color: `rgb(0, 0, 0)`,
                                backgroundColor: `rgb(250, 250, 250)`
                            }
                        }
                        $('#' + 'sum-' + element.toLowerCase()).css('color', colors.color);
                        $('#' + 'sum-' + element.toLowerCase()).css('background-color', colors.backgroundColor);
                    }
                }
                $('#n_comon').text("N=" + (parseFloat($('#sum-no3').text()) + parseFloat($('#sum-nh2').text()) + parseFloat($('#sum-nh4').text())).toFixed(2));
            }

            function handleGramsInputChange() {
                if ($(this).hasClass("grams-input")) {
                    $(this).data("saved-val", $(this).val());
                }
                recalculateSums();
                updateURL();
                parseAndCompare();
            }

            function handleDeleteButtonClick() {
                $(this).closest('tr').remove();
                recalculateSums();
                updateURL();
            }

            function selectAllFertilizers() {
                $('#fertilizer-select option').each(function () {
                    let selectedFertilizerId = $(this).val();
                    if (selectedFertilizerId) {
                        let selectedFertilizer = $('#fertilizer-select option[value="' + selectedFertilizerId + '"]');
                        addFertilizerRow(selectedFertilizer.data(), 0);
                    }
                });
                recalculateSums();
                updateURL();
                $('#fertilizer-select').trigger('select2:updated');
            }

            $("#copy-button").on("click", function () {
                copyURLToClipboard();
            });

            function addFertilizerRow(fertilizer, grams = 0) {
                let newRow = $('<tr class="f-' + fertilizer.pk + '">');
                let firstRow = "";
                firstRow += '<td class="fertilizer-name" data-pk="' + fertilizer.pk + '">';

                if (fertilizer.link) {
                    firstRow += '<a class="f-name" href="' + fertilizer.link + '">' + fertilizer.name + '</a>';
                } else {
                    firstRow += fertilizer.name;
                }

                if (fertilizer.link2) {
                    firstRow += '<a href="' + fertilizer.link2 + '">' + "edit" + '</a>';
                }

                if (fertilizer.moderated == "False") {
                    let dataAttributes = '';
                    for (let key in fertilizer) {
                        if (fertilizer.hasOwnProperty(key)) {
                            let value = fertilizer[key];
                            dataAttributes += 'data-' + key + '="' + value + '" ';
                        }
                    }

                    firstRow += '<a href="#" class="edit-fert text-danger" ' + dataAttributes + '>' + " редактировать " + '</a>';
                }

                if (
                    (fertilizer.description && fertilizer.description !== '') ||
                    (fertilizer.k2o && parseFloat(fertilizer.k2o) !== 0) ||
                    (fertilizer.p2o5 && parseFloat(fertilizer.p2o5) !== 0) ||
                    (fertilizer.cao && parseFloat(fertilizer.cao) !== 0) ||
                    (fertilizer.mgo && parseFloat(fertilizer.mgo) !== 0) ||
                    (fertilizer.cacl && parseFloat(fertilizer.cacl) !== 0)
                ) {
                    firstRow += '<a class="ml-2 fertilizer-name-desc" data-pk="' + fertilizer.pk + '" href="#">описание</a><p id="description-toggle-' + fertilizer.pk + '" class="description-toggle d-none" data-bs-toggle="popover" data-trigger="hover" style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'

                    if (fertilizer.description) {
                        firstRow += fertilizer.description.replace(/\n/g, '<br>');
                    }
                    firstRow += '</p>';
                }
                firstRow += '</td>';
                newRow.append(firstRow);

                newRow.append('<td><input type="number" name="grams" style="width: 100px" value="' + grams + '" step="0.01" data-id="' + fertilizer.id + '" class="grams-input"></td>');
                newRow.append('<td class="element nh4" data-elem="' + fertilizer.nh4 + '">' + fertilizer.nh4 + '</td>');
                newRow.append('<td class="element no3" data-elem="' + fertilizer.no3 + '">' + fertilizer.no3 + '</td>');
                newRow.append('<td class="element nh2" data-elem="' + fertilizer.nh2 + '">' + fertilizer.nh2 + '</td>');
                newRow.append('<td class="element p" data-elem="' + fertilizer.p + '">' + fertilizer.p + '</td>');
                newRow.append('<td class="element k" data-elem="' + fertilizer.k + '">' + fertilizer.k + '</td>');
                newRow.append('<td class="element ca" data-elem="' + fertilizer.ca + '">' + fertilizer.ca + '</td>');
                newRow.append('<td class="element mg" data-elem="' + fertilizer.mg + '">' + fertilizer.mg + '</td>');
                newRow.append('<td class="element s" data-elem="' + fertilizer.s + '">' + fertilizer.s + '</td>');
                newRow.append('<td class="element cl" data-elem="' + fertilizer.cl + '">' + fertilizer.cl + '</td>');
                newRow.append('<td class="element fe" data-elem="' + fertilizer.fe + '">' + fertilizer.fe + '</td>');
                newRow.append('<td class="element zn" data-elem="' + fertilizer.zn + '">' + fertilizer.zn + '</td>');
                newRow.append('<td class="element cu" data-elem="' + fertilizer.cu + '">' + fertilizer.cu + '</td>');
                newRow.append('<td class="element mn" data-elem="' + fertilizer.mn + '">' + fertilizer.mn + '</td>');
                newRow.append('<td class="element mo" data-elem="' + fertilizer.mo + '">' + fertilizer.mo + '</td>');
                newRow.append('<td class="element b" data-elem="' + fertilizer.b + '">' + fertilizer.b + '</td>');
                newRow.append('<td class="element co" data-elem="' + fertilizer.co + '">' + fertilizer.co + '</td>');
                newRow.append('<td class="element si" data-elem="' + fertilizer.si + '">' + fertilizer.si + '</td>');
                newRow.append('<td><button class="delete-button">Удалить</button></td>');
                newRow.append('<td class="ec"></td>');

                newRow.find('.grams-input').on('input', handleGramsInputChange);
                newRow.find('.delete-button').on('click', handleDeleteButtonClick);
                newRow.find('.fertilizer-name-desc').on('click', function () {
                    $("#description-toggle-" + $(this).data('pk')).toggleClass('d-none');
                });

                $('.fert > tbody ').append(newRow);
            }

            $("#litres").on('change', function () {
                $('input.grams-input').each(function () {
                    let t = parseFloat($(this).val()) / parseFloat($("#litres").data("saved-val")) * parseFloat($("#litres").val());
                    $('#itog').text("Итого на " + $("#litres").val() + " л");
                    $(this).val(t.toFixed('2'))
                    $(this).data("saved-val", $(this).val());
                })
                handleGramsInputChange();
            });

            function add_form_events() {
                $("#form-edit_plant_fert").on('submit', function (event) {
                    event.preventDefault();

                    let formData = $(this).serialize();

                    $.ajax({
                        type: "POST",
                        url: $(this).attr("action"),
                        data: formData,
                        dataType: "json",
                        success: function (response) {
                            display_msg("Успешно", error = false);

                            let row = $(".f-" + response.pk);
                            let mgrams = parseFloat(row.find('.grams-input').val()) * 100;

                            row.find('.f-name').text(response.name);
                            row.find('.element.nh4').text((parseFloat(response.N_NH4) * mgrams).toFixed(2));
                            row.find('.element.nh4').attr("data-elem", parseFloat(response.N_NH4).toFixed(2));
                            row.find('.element.no3').text((parseFloat(response.N_NO3) * mgrams).toFixed(2));
                            row.find('.element.no3').attr("data-elem", parseFloat(response.N_NO3).toFixed(2));
                            row.find('.element.nh2').text((parseFloat(response.N_NH2) * mgrams).toFixed(2));
                            row.find('.element.nh2').attr("data-elem", parseFloat(response.N_NH2).toFixed(2));
                            row.find('.element.p').attr("data-elem", parseFloat(response.P).toFixed(2));
                            row.find('.element.p').text((parseFloat(response.P) * mgrams).toFixed(2));
                            row.find('.element.k').text(parseFloat(response.K).toFixed(2)) * mgrams;
                            row.find('.element.ca').text(parseFloat(response.Ca).toFixed(2)) * mgrams;
                            row.find('.element.mg').text(parseFloat(response.Mg).toFixed(2)) * mgrams;
                            row.find('.element.s').text(parseFloat(response.S).toFixed(2)) * mgrams;
                            row.find('.element.cl').text(parseFloat(response.Cl).toFixed(2)) * mgrams;
                            row.find('.element.fe').text(parseFloat(response.Fe).toFixed(2)) * mgrams;
                            row.find('.element.zn').text(parseFloat(response.Zn).toFixed(2)) * mgrams;
                            row.find('.element.cu').text(parseFloat(response.Cu).toFixed(2)) * mgrams;
                            row.find('.element.mn').text(parseFloat(response.Mn).toFixed(2)) * mgrams;
                            row.find('.element.mo').text(parseFloat(response.Mo).toFixed(2)) * mgrams;
                            row.find('.element.b').text(parseFloat(response.B).toFixed(2)) * mgrams;
                            row.find('.element.co').text(parseFloat(response.Co).toFixed(2)) * mgrams;
                            row.find('.element.si').text(parseFloat(response.Si).toFixed(2)) * mgrams;
                            recalculateSums();
                        },
                        error: function (xhr, status, error) {
                            let errorMessage = xhr.responseJSON ? xhr.responseJSON.errors : "Произошла ошибка при обработке формы.";
                            display_msg(errorMessage, error = true);
                        }
                    });
                });
            }

            function display_msg(errorMessage, error = false) {
                if (error === true) {
                    let errorContainer = $("#edit_plant_fert #form-error");
                    errorContainer.text(errorMessage);
                } else {
                    let errorContainer = $("#edit_plant_fert #form-success");
                    errorContainer.text(errorMessage);
                }
            }

            function updateOriginalFields() {
                let k2oValue = parseFloat($("#form-edit_plant_fert #id_K2O").val());
                let p2o5Value = parseFloat($("#form-edit_plant_fert #id_P2O5").val());
                let caoValue = parseFloat($("#form-edit_plant_fert #id_CaO").val());
                let mgoValue = parseFloat($("#form-edit_plant_fert #id_MgO").val());
                let so3Value = parseFloat($("#form-edit_plant_fert #id_SO3").val());

                if (!isNaN(k2oValue)) {
                    let kValue = (k2oValue * 0.83015).toFixed(4);
                    $("#form-edit_plant_fert #id_K").val(kValue);
                }

                if (!isNaN(p2o5Value)) {
                    let pValue = (p2o5Value * 0.43642).toFixed(4);
                    $("#form-edit_plant_fert #id_P").val(pValue);
                }

                if (!isNaN(caoValue)) {
                    let caValue = (caoValue * 0.71469).toFixed(4);
                    $("#form-edit_plant_fert #id_Ca").val(caValue);
                }

                if (!isNaN(mgoValue)) {
                    let mgValue = (mgoValue * 0.603).toFixed(4);
                    $("#form-edit_plant_fert #id_Mg").val(mgValue);
                }

                if (!isNaN(so3Value)) {
                    let sValue = (so3Value / 2.497).toFixed(4);
                    $("#form-edit_plant_fert #id_S").val(sValue);
                }
            }

            function updateComputedFields() {
                let kValue = parseFloat($("#form-edit_plant_fert #id_K").val());
                let pValue = parseFloat($("#form-edit_plant_fert #id_P").val());
                let caValue = parseFloat($("#form-edit_plant_fert #id_Ca").val());
                let mgValue = parseFloat($("#form-edit_plant_fert #id_Mg").val());
                let sValue = parseFloat($("#form-edit_plant_fert #id_S").val());

                if (!isNaN(kValue)) {
                    let k2oValue = (kValue / 0.83015).toFixed(4);
                    $("#form-edit_plant_fert #id_K2O").val(k2oValue);
                }

                if (!isNaN(pValue)) {
                    let p2o5Value = (pValue / 0.43642).toFixed(4);
                    $("#form-edit_plant_fert #id_P2O5").val(p2o5Value);
                }

                if (!isNaN(caValue)) {
                    let caoValue = (caValue / 0.71469).toFixed(4);
                    $("#form-edit_plant_fert #id_CaO").val(caoValue);
                }

                if (!isNaN(mgValue)) {
                    let mgoValue = (mgValue / 0.603).toFixed(4);
                    $("#form-edit_plant_fert #id_MgO").val(mgoValue);
                }

                if (!isNaN(sValue)) {
                    let so3Value = (sValue * 2.497).toFixed(4);
                    $("#form-edit_plant_fert #id_SO3").val(so3Value);
                }
            }

            $("#form-edit_plant_fert #id_K, #form-edit_plant_fert #id_P, #form-edit_plant_fert #id_Ca, #form-edit_plant_fert #id_Mg, #form-edit_plant_fert #id_S").on('change', function () {
                updateComputedFields();
            });

            $("#form-edit_plant_fert #id_K2O, #form-edit_plant_fert #id_P2O5, #form-edit_plant_fert #id_CaO, #form-edit_plant_fert #id_MgO, #form-edit_plant_fert #id_SO3").on('change', function () {
                updateOriginalFields();
            });

            function add_edit_listener() {
                $(".edit-fert").on('click', function () {
                    $("#edit_plant_fert #form-error").text("");
                    $("#edit_plant_fert #form-success").text("");
                    let fertilizer = $(this).data();
                    $("#form-edit_plant_fert").attr(
                        "action",
                        "/calc/fert-new/" + $(this).data('pk') + "/"
                    );
                    for (let key in fertilizer) {
                        if (fertilizer.hasOwnProperty(key)) {
                            let value = fertilizer[key];
                            if (value !== null && value !== "None") {
                                let fieldName = fieldNames[key];
                                let item = $("#form-edit_plant_fert #id_" + fieldName);
                                value = String(value).replace(',', '.');
                                if (!isNaN(parseFloat(value))) {
                                    item.val(parseFloat(value).toFixed(4));
                                } else {
                                    item.val(value);
                                }
                            }
                        }
                    }
                    $("#edit_plant_fert").modal('show');
                });
            }

            $("#sum-p").change(function (e) {
                console.log("oldvalue", this.oldvalue);
                console.log("value", this.value);
            })


            $(document).ready(function () {


                $('#fertilizer-select').select2({
                    width: 'resolve',
                    placeholder: 'Выберите удобрение'
                });


                $('.fert > tbody > tr:not(#sum-row):not(#comp-row) input.grams-input').on('input', function () {
                    handleGramsInputChange();
                    updateURL();
                });
                $('.fert > tbody > tr:not(#sum-row):not(#comp-row) button.delete-button').on('click', function () {
                    $(this).closest('tr').remove();
                    handleDeleteButtonClick();
                    updateURL();
                });

                $('#fertilizer-select').on('change', function () {
                    let selectedFertilizerId = $(this).val();
                    if (selectedFertilizerId) {
                        let selectedFertilizer = $('#fertilizer-select option[value="' + selectedFertilizerId + '"]');
                        addFertilizerRow(selectedFertilizer.data(), 0);
                        recalculateSums();
                        updateURL();
                    }
                });

                loadTableFromURL();

                $('input').each(function () {
                    $(this).data('saved-val', $(this).val());
                });

                $('input').on('focus', function () {
                    $(this).data('saved-val', $(this).val());
                });
                $('.fertilizer-name').click(function () {
                    $("description-toggle-" + $(this).data('pk')).toggle();
                });
                $('#select-all-button').on('click', function () {
                    selectAllFertilizers();
                });
                $('#de-select-all-button').on('click', function () { // Добавляем обработчик события для кнопки "Убрать все"
                    deSelectAllFertilizers();
                });

                add_edit_listener();
                add_form_events();

                $("#id_K2O, #id_P2O5, #id_CaO, #id_MgO").on('change', function () {
                    updateOriginalFields();
                });
                $("#id_K, #id_P, #id_Ca, #id_Mg").on('change', function () {
                    updateComputedFields();
                });
            });

            function parseAndCompare() {
                let inputString = document.getElementById('input-string').value;

                if (!inputString) {
                    $('#comp-row').addClass('d-none');
                } else {
                    $('#comp-row').removeClass('d-none');
                }

                let pattern = /(\w+)=([0-9.]+)/g;
                let match;

                if (inputString) {
                    while (match = pattern.exec(inputString)) {
                        let element = match[1];
                        let value = parseFloat(match[2]);
                        let cell = document.getElementById('comp-' + element.toLowerCase());

                        if (cell) {
                            cell.textContent = value.toFixed(2);
                            compareValues(element, value);
                        }
                    }
                }
            }

            function compareValues(element, value) {
                let l_element = element.toLowerCase();
                let sumCell = document.getElementById('sum-' + l_element);

                if (sumCell) {
                    let sumValue = parseFloat(sumCell.textContent);
                    let inputCell = document.getElementById('comp-' + l_element);
                    let difference = value - sumValue;
                    let percentageDifference = (difference / sumValue) * 100;
                    if (percentageDifference > 0.1 && percentageDifference < 90) {
                        percentageDifference += 10;
                    }

                    inputCell.style.backgroundColor = getDifferenceColor(percentageDifference);
                } else {
                    console.log("no sum cell", l_element);
                }
            }

            function getDifferenceColor(percentageDifference) {
                if (percentageDifference == 0) {
                    return '';
                } else {
                    const alpha = Math.min(Math.abs(percentageDifference) / 100, 1);
                    return `rgba(${percentageDifference > 0 ? '255, 99, 71' : '255, 0, 0'}, ${alpha})`;
                }
            }

            function deSelectAllFertilizers() {
                $('.fert > tbody > tr:not(#sum-row):not(#comp-row)').remove(); // Удаляем все строки, кроме суммирующих
                recalculateSums(); // Пересчитываем суммы
                updateURL(); // Обновляем URL
            }


        </script>


    {% endcompress %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.0.0/math.min.js"></script>
    {% compress js %}
        <script src="/static/kislota.js"></script>
    {% endcompress %}

{% endblock %}




